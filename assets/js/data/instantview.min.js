var InstantView=function(document,location){var userAgent=navigator.userAgent;var isTouchDevice="createTouch" in document;var currentLocationWithoutHash;var preloadingHref;var preloadingTimer;var pageCache={};var xhr;var urlToPreload=!1;var lastTouchTimestamp=!1;var isPreloadingBroken=!1;var isPreloadingFinished=!1;var timingData={};var isPreloading=!1;var isWaitingForCompletion=!1;var trackedAssets=[];var isWhitelistMode;var isMousedownTrigger;var delayBeforePreload;var eventListeners={fetch:[],receive:[],wait:[],change:[]};var processedScripts={};var scriptExecutionQueue=[];var isProcessingScripts=!1;var scriptContexts={};var scriptDependencies={};var globalVariableRegistry={};function removeHash(url){var hashIndex=url.indexOf('#');if(hashIndex<0){return url}
return url.substr(0,hashIndex)}
function findAnchorElement(element){if(!element)return null;while(element&&element.nodeName!="A"){element=element.parentNode;if(!element)return null}
return element}
function isInstantDisabled(element){if(!element)return!0;do{if(!element.hasAttribute){break}
if(element.hasAttribute("data-instant")){return!1}
if(element.hasAttribute("data-no-instant")){return!0}}while(element=element.parentNode);return!1}
function isInstantEnabled(element){if(!element)return!1;do{if(!element.hasAttribute){break}
if(element.hasAttribute("data-no-instant")){return!1}
if(element.hasAttribute("data-instant")){return!0}}while(element=element.parentNode);return!1}
function triggerEvent(eventType,arg){if(!eventListeners[eventType]){console.warn('InstantView: Unknown event type:',eventType);return}
for(var i=0;i<eventListeners[eventType].length;i++){eventListeners[eventType][i](arg)}}
function generateScriptId(str){if(!str)return'empty';var hash=0;for(var i=0;i<str.length;i++){var char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash=hash&hash}
return hash.toString(36)}
function createScriptSandbox(scriptContent,scriptId){if(!scriptContent)return{};try{var contextId='ctx_'+scriptId;var sandbox={};return new Proxy(sandbox,{set:function(target,prop,value){target[prop]=value;if(!window[prop]||typeof window[prop]==='undefined'){window[prop]=value}
return!0},get:function(target,prop){if(prop in target){return target[prop]}
return window[prop]}})}catch(e){console.error('InstantView: Failed to create script sandbox:',e);return{}}}
function executeSandboxedScript(scriptContent,scriptId){try{var sandbox=createScriptSandbox(scriptContent,scriptId);var safeContent=scriptContent.replace(/^\s*import\s+.*?from\s+['"].*?['"];?\s*$/gm,'// Import removed for compatibility').replace(/^\s*export\s+.*?;?\s*$/gm,'// Export removed for compatibility');var scriptFunction=new Function('window','document','console','setTimeout','clearTimeout','setInterval','clearInterval',safeContent);scriptFunction.call(sandbox,window,document,console,setTimeout,clearTimeout,setInterval,clearInterval);scriptContexts[scriptId]=sandbox;return!0}catch(e){console.error('InstantView: Error executing script:',e.message);return!1}}
function safeExecuteScript(scriptElement,targetParent,nextSibling){if(!scriptElement||scriptElement.hasAttribute("data-no-instant")){return}
var scriptId;var scriptSrc=scriptElement.src||'';var scriptContent=scriptElement.innerHTML||'';var scriptType=scriptElement.type||'';if(scriptType&&scriptType!=='text/javascript'&&scriptType!=='application/javascript'&&scriptType!==''){return}
if(scriptSrc){scriptId=scriptSrc}else{scriptId=generateScriptId(scriptContent)}
var currentTime=Date.now();if(processedScripts[scriptId]&&(currentTime-processedScripts[scriptId])<5000){return}
processedScripts[scriptId]=currentTime;var newScript=document.createElement("script");newScript.setAttribute('data-instantview-processed','true');if(scriptSrc){newScript.src=scriptSrc;Array.from(scriptElement.attributes).forEach(function(attr){if(attr.name!=='src'&&attr.name!=='type'){newScript.setAttribute(attr.name,attr.value)}});newScript.onerror=function(e){console.error('InstantView: Failed to load script:',scriptSrc)}}else if(scriptContent){try{var success=executeSandboxedScript(scriptContent,scriptId);if(!success){newScript.innerHTML=scriptContent}else{return}}catch(e){console.error('InstantView: Error sandboxing script:',e);newScript.innerHTML=scriptContent}}
if(nextSibling){targetParent.insertBefore(newScript,nextSibling)}else{targetParent.appendChild(newScript)}}
function changePage(title,body,url,scrollY){document.title=title;if(body&&document.documentElement){document.documentElement.replaceChild(body,document.body)}else{console.error('InstantView: Cannot replace document body');return}
if(url){history.pushState(null,null,url);var hashIndex=url.indexOf('#');var hashElement=hashIndex>-1&&document.getElementById(url.substr(hashIndex+1));var scrollPosition=0;if(hashElement){while(hashElement.offsetParent){scrollPosition+=hashElement.offsetTop;hashElement=hashElement.offsetParent}}
scrollTo(0,scrollPosition);currentLocationWithoutHash=removeHash(url)}else{scrollTo(0,scrollY)}
scriptContexts={};setupLinkHovers();triggerEvent("change",!1)}
function resetPreloading(){isPreloading=!1;isWaitingForCompletion=!1}
function mousedownHandler(event){var anchor=findAnchorElement(event.target);if(!anchor)return;preload(anchor.href)}
function mouseoverHandler(event){var anchor=findAnchorElement(event.target);if(!anchor)return;anchor.addEventListener("mouseout",mouseoutHandler);if(!delayBeforePreload){preload(anchor.href)}else{preloadingHref=anchor.href;preloadingTimer=setTimeout(preload,delayBeforePreload)}}
function touchstartHandler(event){var anchor=findAnchorElement(event.target);if(!anchor)return;if(isMousedownTrigger){anchor.removeEventListener("mousedown",mousedownHandler)}else{anchor.removeEventListener("mouseover",mouseoverHandler)}
preload(anchor.href)}
function clickHandler(event){if(event.which>1||event.metaKey||event.ctrlKey){return}
event.preventDefault();var anchor=findAnchorElement(event.target);if(!anchor)return;display(anchor.href)}
function mouseoutHandler(){if(preloadingTimer){clearTimeout(preloadingTimer);preloadingTimer=!1;return}
if(!isPreloading||isWaitingForCompletion){return}
xhr.abort();resetPreloading()}
function readystatechangeHandler(){if(xhr.readyState<4){return}
if(xhr.status==0){return}
timingData.ready=+new Date-timingData.start;triggerEvent("receive");var contentType=xhr.getResponseHeader("Content-Type");if(contentType&&contentType.match(/\/(x|ht|xht)ml/)){var doc=document.implementation.createHTMLDocument("");doc.documentElement.innerHTML=xhr.responseText;lastTouchTimestamp=doc.title;isPreloadingFinished=doc.body;var urlWithoutHash=removeHash(urlToPreload);pageCache[urlWithoutHash]={body:isPreloadingFinished,title:lastTouchTimestamp,scrollY:urlWithoutHash in pageCache?pageCache[urlWithoutHash].scrollY:0};var headChildren=doc.head.children;var trackedAssetCount=0;var currentElem;var assetValue;for(var i=headChildren.length-1;i>=0;i--){currentElem=headChildren[i];if(currentElem.hasAttribute("data-instant-track")){assetValue=currentElem.getAttribute("href")||currentElem.getAttribute("src")||currentElem.innerHTML;for(var j=trackedAssets.length-1;j>=0;j--){if(trackedAssets[j]==assetValue){trackedAssetCount++}}}}
if(trackedAssetCount!=trackedAssets.length){isPreloadingBroken=!0}}else{isPreloadingBroken=!0}
if(isWaitingForCompletion){isWaitingForCompletion=!1;display(urlToPreload)}}
function processScriptBatch(scripts,startIndex){if(isProcessingScripts){scriptExecutionQueue.push({scripts:scripts,startIndex:startIndex});return}
isProcessingScripts=!0;var batchSize=3;var endIndex=Math.min(startIndex+batchSize,scripts.length);try{for(var i=startIndex;i<endIndex;i++){var scriptElement=scripts[i];if(scriptElement&&!scriptElement.hasAttribute("data-instantview-processed")){var parentNode=scriptElement.parentNode;if(!parentNode)continue;safeExecuteScript(scriptElement,parentNode,scriptElement.nextSibling)}}}catch(e){console.error('InstantView: Error in script batch processing:',e)}
if(endIndex<scripts.length){setTimeout(function(){isProcessingScripts=!1;processScriptBatch(scripts,endIndex)},30)}else{setTimeout(function(){isProcessingScripts=!1;if(scriptExecutionQueue.length>0){var next=scriptExecutionQueue.shift();processScriptBatch(next.scripts,next.startIndex)}},50)}}
function setupLinkHovers(isFirstRun){var links=document.getElementsByTagName("a");var linkElement;var urlBase=location.protocol+"//"+location.host;for(var i=links.length-1;i>=0;i--){linkElement=links[i];if(linkElement.target||linkElement.hasAttribute("download")||linkElement.href.indexOf(urlBase+"/")!=0||(linkElement.href.indexOf('#')>-1&&removeHash(linkElement.href)==currentLocationWithoutHash)||(isWhitelistMode?!isInstantEnabled(linkElement):isInstantDisabled(linkElement))){continue}
linkElement.addEventListener("touchstart",touchstartHandler);if(isMousedownTrigger){linkElement.addEventListener("mousedown",mousedownHandler)}else{linkElement.addEventListener("mouseover",mouseoverHandler)}
linkElement.addEventListener("click",clickHandler)}
if(!isFirstRun){if(Object.keys(processedScripts).length>100){processedScripts={}}
var scripts=document.body.getElementsByTagName("script");var scriptArray=Array.from(scripts);scriptArray.sort(function(a,b){var aParent=a.parentNode;var bParent=b.parentNode;if(aParent===bParent){return Array.from(aParent.children).indexOf(a)-Array.from(bParent.children).indexOf(b)}
return 0});setTimeout(function(){processScriptBatch(scriptArray,0)},50)}}
function preload(url){if(!isMousedownTrigger&&"display" in timingData&&+new Date-(timingData.start+timingData.display)<100){return}
if(preloadingTimer){clearTimeout(preloadingTimer);preloadingTimer=!1}
if(!url){url=preloadingHref}
if(isPreloading&&(url==urlToPreload||isWaitingForCompletion)){return}
isPreloading=!0;isWaitingForCompletion=!1;urlToPreload=url;isPreloadingFinished=!1;isPreloadingBroken=!1;timingData={start:+new Date};triggerEvent("fetch");try{xhr.open("GET",url);xhr.send()}catch(e){console.error("InstantView: XHR error",e);isPreloadingBroken=!0;resetPreloading()}}
function display(url){if(!("display" in timingData)){timingData.display=+new Date-timingData.start}
if(preloadingTimer){if(urlToPreload&&urlToPreload!=url){location.href=url;return}
preload(url);triggerEvent("wait");isWaitingForCompletion=!0;return}
if(!isPreloading||isWaitingForCompletion){location.href=url;return}
if(isPreloadingBroken){location.href=urlToPreload;return}
if(!isPreloadingFinished){triggerEvent("wait");isWaitingForCompletion=!0;return}
if(currentLocationWithoutHash&&pageCache[currentLocationWithoutHash]){pageCache[currentLocationWithoutHash].scrollY=pageYOffset}
resetPreloading();scriptExecutionQueue=[];isProcessingScripts=!1;scriptContexts={};var globalSnapshot={};try{Object.keys(window).forEach(function(key){if(typeof window[key]==='function'||key.startsWith('_'))return;globalSnapshot[key]=window[key]})}catch(e){console.warn('InstantView: Error creating global snapshot:',e)}
changePage(lastTouchTimestamp,isPreloadingFinished,urlToPreload);try{Object.keys(globalSnapshot).forEach(function(key){if(typeof window[key]==='undefined'){window[key]=globalSnapshot[key]}})}catch(e){console.warn('InstantView: Error restoring global snapshot:',e)}}
var loadingIndicator={init:function(){},start:function(){},done:function(){}};var isSupported="pushState" in history&&(!userAgent.match("Android")||userAgent.match("Chrome/"))&&location.protocol!="file:";function init(){if(currentLocationWithoutHash){return}
if(!isSupported){triggerEvent("change",!0);return}
for(var i=arguments.length-1;i>=0;i--){var arg=arguments[i];if(arg===!0){isWhitelistMode=!0}else if(arg=="mousedown"){isMousedownTrigger=!0}else if(typeof arg=="number"){delayBeforePreload=arg}}
currentLocationWithoutHash=removeHash(location.href);pageCache[currentLocationWithoutHash]={body:document.body,title:document.title,scrollY:pageYOffset};var headChildren=document.head.children;var assetValue;for(var i=headChildren.length-1;i>=0;i--){var elem=headChildren[i];if(elem.hasAttribute("data-instant-track")){assetValue=elem.getAttribute("href")||elem.getAttribute("src")||elem.innerHTML;trackedAssets.push(assetValue)}}
xhr=new XMLHttpRequest();xhr.addEventListener("readystatechange",readystatechangeHandler);setupLinkHovers(!0);loadingIndicator.init();triggerEvent("change",!0);addEventListener("popstate",function(){var url=removeHash(location.href);if(url==currentLocationWithoutHash){return}
if(!(url in pageCache)){location.href=location.href;return}
pageCache[currentLocationWithoutHash].scrollY=pageYOffset;currentLocationWithoutHash=url;changePage(pageCache[url].title,pageCache[url].body,!1,pageCache[url].scrollY)});window._instantViewInternal={scriptContexts:scriptContexts,processedScripts:processedScripts}}
function addEventListeners(eventType,callback){if(!eventListeners[eventType]){eventListeners[eventType]=[]}
eventListeners[eventType].push(callback)}
return{supported:isSupported,init:init,on:addEventListeners}}(document,location)